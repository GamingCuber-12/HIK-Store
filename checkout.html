<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Checkout - HIK Store UAE</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Config will be injected by GitHub Actions -->
    <script src="config.js"></script>
    
    <style>
        /* ===================== MAIN STYLES ===================== */
        :root {
            --primary: #1E40AF;
            --primary-dark: #1E3A8A;
            --accent: #06B6D4;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --bg: #F8FAFC;
            --bg-light: #F1F5F9;
            --card-bg: #FFFFFF;
            --border: #E2E8F0;
            --text: #0F172A;
            --text-light: #475569;
            --shadow: 0 10px 40px rgba(15, 23, 42, 0.08);
            --shadow-lg: 0 20px 60px rgba(15, 23, 42, 0.12);
            --radius: 16px;
            --radius-lg: 24px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
            color: var(--text);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(30, 64, 175, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(6, 182, 212, 0.03) 0%, transparent 50%);
            z-index: -1;
        }
        
        /* ===================== LAYOUT ===================== */
        .checkout-container {
            max-width: 1400px;
            margin: 0 auto;
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        /* ===================== HEADER ===================== */
        .checkout-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 20px 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            text-decoration: none;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 8px 20px rgba(30, 64, 175, 0.2);
        }
        
        .logo-text h1 {
            font-size: 24px;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .logo-text p {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 500;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .cart-count {
            background: linear-gradient(135deg, var(--success) 0%, var(--accent) 100%);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        /* ===================== PROGRESS BAR ===================== */
        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin: 0 auto 60px;
            max-width: 900px;
            position: relative;
            padding: 0 40px;
        }
        
        .progress-bar:before {
            content: '';
            position: absolute;
            top: 24px;
            left: 80px;
            right: 80px;
            height: 6px;
            background: linear-gradient(to right, var(--border) 0%, var(--border) 100%);
            background-size: 100% 6px;
            z-index: 1;
            border-radius: 3px;
        }
        
        .progress-bar.active:before {
            background: linear-gradient(to right, var(--primary) var(--progress), var(--border) var(--progress));
        }
        
        .progress-step {
            text-align: center;
            position: relative;
            z-index: 2;
            flex: 1;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .progress-step:hover .step-number:not(.active) {
            transform: scale(1.1);
            box-shadow: var(--shadow);
        }
        
        .step-number {
            width: 52px;
            height: 52px;
            background: var(--card-bg);
            border: 4px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-weight: 900;
            color: var(--text-light);
            transition: var(--transition);
            font-size: 1.3rem;
            position: relative;
            overflow: hidden;
        }
        
        .step-number:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            opacity: 0;
            transition: var(--transition);
        }
        
        .progress-step.active .step-number {
            border-color: transparent;
            color: white;
            transform: scale(1.15);
            box-shadow: 0 12px 30px rgba(30, 64, 175, 0.4);
        }
        
        .progress-step.active .step-number:before {
            opacity: 1;
        }
        
        .progress-step.completed .step-number {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .step-number i {
            position: relative;
            z-index: 2;
        }
        
        .step-label {
            font-size: 1rem;
            color: var(--text-light);
            font-weight: 700;
            transition: var(--transition);
        }
        
        .progress-step.active .step-label {
            color: var(--primary);
            transform: translateY(2px);
        }
        
        /* ===================== ALERTS ===================== */
        .alert-container {
            margin-bottom: 30px;
            position: sticky;
            top: 20px;
            z-index: 100;
        }
        
        .alert {
            padding: 25px 30px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            border: 1px solid;
            background: rgba(255, 255, 255, 0.95);
            align-items: center;
            gap: 20px;
            box-shadow: var(--shadow);
        }
        
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(-20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .alert.show {
            display: flex;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: #065F46;
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #991B1B;
        }
        
        .alert-info {
            background: rgba(30, 64, 175, 0.1);
            border-color: rgba(30, 64, 175, 0.3);
            color: #1E40AF;
        }
        
        .alert-icon {
            font-size: 28px;
            flex-shrink: 0;
        }
        
        /* ===================== CHECKOUT GRID ===================== */
        .checkout-grid {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 40px;
            margin-bottom: 60px;
        }
        
        @media (max-width: 1200px) {
            .checkout-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* ===================== FORMS ===================== */
        .checkout-forms {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .checkout-section {
            display: none;
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .checkout-section.active {
            display: block;
        }
        
        .checkout-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 50px;
            border: 1px solid var(--border);
            backdrop-filter: blur(20px);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .checkout-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-5px);
        }
        
        .checkout-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
        }
        
        @media (max-width: 768px) {
            .checkout-card {
                padding: 30px;
            }
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 25px;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid var(--border);
        }
        
        .section-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            flex-shrink: 0;
            box-shadow: 0 12px 30px rgba(30, 64, 175, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .section-icon:after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.1) 50%,
                transparent 70%
            );
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .section-header h2 {
            color: var(--text);
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .section-header p {
            color: var(--text-light);
            font-size: 1.1rem;
            line-height: 1.6;
            max-width: 600px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .form-group {
            margin-bottom: 30px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 12px;
            font-weight: 700;
            color: var(--text);
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group label i {
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 20px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 1.1rem;
            transition: var(--transition);
            background: var(--bg-light);
            color: var(--text);
            font-weight: 500;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.15);
            transform: translateY(-2px);
        }
        
        .form-group.error input,
        .form-group.error select {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.05);
            animation: shake 0.5s ease;
        }
        
        .error-message {
            color: var(--error);
            font-size: 0.95rem;
            margin-top: 10px;
            display: none;
            font-weight: 600;
            padding-left: 5px;
        }
        
        .error-message.show {
            display: block;
        }
        
        /* ===================== PAYMENT METHODS ===================== */
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .payment-method {
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: var(--bg-light);
            position: relative;
            overflow: hidden;
        }
        
        .payment-method:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }
        
        .payment-method.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(30, 64, 175, 0.05) 0%, rgba(6, 182, 212, 0.05) 100%);
            box-shadow: 0 0 0 2px var(--primary);
        }
        
        .payment-method.selected:before {
            content: '‚úì';
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--primary);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
        }
        
        .payment-icon {
            font-size: 48px;
            margin-bottom: 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            gap: 10px;
        }
        
        .payment-name {
            font-weight: 900;
            color: var(--text);
            margin-bottom: 10px;
            font-size: 1.3rem;
        }
        
        .payment-desc {
            font-size: 0.9rem;
            color: var(--text-light);
            line-height: 1.5;
        }
        
        /* ===================== ORDER SUMMARY ===================== */
        .order-summary {
            position: sticky;
            top: 40px;
            height: fit-content;
        }
        
        .summary-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 35px;
            padding-bottom: 25px;
            border-bottom: 2px solid var(--border);
        }
        
        .summary-title {
            font-size: 1.6rem;
            font-weight: 900;
            color: var(--text);
            flex: 1;
        }
        
        .verification-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--success) 0%, var(--success) 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 0.95rem;
            font-weight: 900;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }
        
        .summary-items {
            margin-bottom: 30px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 15px;
        }
        
        .summary-items::-webkit-scrollbar {
            width: 8px;
        }
        
        .summary-items::-webkit-scrollbar-track {
            background: var(--bg-light);
            border-radius: 4px;
        }
        
        .summary-items::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        .summary-items::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        .summary-item {
            display: flex;
            gap: 20px;
            padding: 25px 0;
            border-bottom: 1px solid var(--border);
            align-items: center;
            transition: var(--transition);
        }
        
        .summary-item:hover {
            transform: translateX(5px);
        }
        
        .item-image {
            width: 100px;
            height: 100px;
            border-radius: var(--radius);
            object-fit: contain;
            background: var(--bg-light);
            padding: 15px;
            flex-shrink: 0;
            border: 1px solid var(--border);
            transition: var(--transition);
        }
        
        .summary-item:hover .item-image {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .item-details {
            flex: 1;
        }
        
        .item-name {
            font-weight: 700;
            color: var(--text);
            margin-bottom: 10px;
            font-size: 1.1rem;
            line-height: 1.4;
        }
        
        .item-price {
            color: var(--primary);
            font-weight: 900;
            font-size: 1.4rem;
        }
        
        .item-quantity {
            color: var(--text-light);
            font-size: 0.95rem;
            font-weight: 600;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .summary-totals {
            background: linear-gradient(135deg, var(--bg-light) 0%, var(--card-bg) 100%);
            padding: 35px;
            border-radius: var(--radius-lg);
            margin-top: 30px;
            border: 1px solid var(--border);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 1.1rem;
            padding: 10px 0;
            border-bottom: 1px dashed var(--border);
        }
        
        .total-row:last-of-type {
            border-top: 2px solid var(--border);
            padding-top: 20px;
            margin-top: 20px;
            font-size: 1.6rem;
            font-weight: 900;
            color: var(--primary);
            border-bottom: none;
        }
        
        /* ===================== BUTTONS ===================== */
        .btn {
            padding: 22px 40px;
            border-radius: var(--radius);
            border: none;
            font-size: 1.2rem;
            font-weight: 800;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            width: 100%;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            transition: 0.5s;
        }
        
        .btn:hover:before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            box-shadow: 0 12px 30px rgba(30, 64, 175, 0.3);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(30, 64, 175, 0.4);
        }
        
        .btn-secondary {
            background: var(--bg);
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: rgba(30, 64, 175, 0.05);
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-group {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }
        
        /* ===================== LOADING & ANIMATIONS ===================== */
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===================== SECURITY BADGES ===================== */
        .security-badge {
            display: flex;
            align-items: center;
            gap: 20px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(30, 64, 175, 0.1) 100%);
            padding: 25px;
            border-radius: var(--radius);
            margin-top: 40px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        
        .security-badge:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%231E40AF' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.3;
        }
        
        .security-icon {
            color: var(--success);
            font-size: 32px;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }
        
        .security-badge div {
            position: relative;
            z-index: 1;
        }
        
        /* ===================== TIMER ===================== */
        .timer {
            text-align: center;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(239, 68, 68, 0.1) 100%);
            padding: 25px;
            border-radius: var(--radius);
            margin: 30px 0;
            border: 1px solid rgba(245, 158, 11, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .timer:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .timer i {
            margin-right: 10px;
            color: var(--warning);
            font-size: 1.2rem;
        }
        
        .timer-expired {
            color: var(--error);
            font-weight: 900;
            animation: pulse 2s infinite;
        }
        
        /* ===================== CONFIRMATION PAGE ===================== */
        .order-confirmation {
            text-align: center;
            padding: 40px;
        }
        
        .confirmation-icon {
            width: 140px;
            height: 140px;
            background: linear-gradient(135deg, var(--success) 0%, var(--success) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 40px;
            color: white;
            font-size: 56px;
            animation: bounce 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 20px 40px rgba(16, 185, 129, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .confirmation-icon:after {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: conic-gradient(
                from 0deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: rotate 3s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .confirmation-icon i {
            position: relative;
            z-index: 1;
        }
        
        .order-confirmation h1 {
            margin-bottom: 20px;
            color: var(--success);
            font-size: 2.5rem;
            font-weight: 900;
        }
        
        .order-details {
            background: linear-gradient(135deg, var(--bg-light) 0%, var(--card-bg) 100%);
            padding: 40px;
            border-radius: var(--radius-lg);
            margin: 40px auto;
            text-align: left;
            border: 1px solid var(--border);
            max-width: 800px;
            box-shadow: var(--shadow);
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        /* ===================== TERMS CHECKBOX ===================== */
        .terms-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin: 30px 0;
            padding: 25px;
            background: var(--bg-light);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            transition: var(--transition);
        }
        
        .terms-checkbox:hover {
            background: rgba(30, 64, 175, 0.02);
            transform: translateY(-2px);
        }
        
        .terms-checkbox input {
            margin-top: 5px;
            transform: scale(1.4);
            cursor: pointer;
        }
        
        .terms-checkbox input:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        .terms-link {
            color: var(--primary);
            font-weight: 700;
            text-decoration: none;
            transition: var(--transition);
        }
        
        .terms-link:hover {
            text-decoration: underline;
            color: var(--primary-dark);
        }
        
        /* ===================== FOOTER ===================== */
        .checkout-footer {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-light);
            font-size: 1rem;
            border-top: 1px solid var(--border);
            margin-top: 60px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: var(--radius-lg);
            backdrop-filter: blur(10px);
        }
        
        .payment-icons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            font-size: 2rem;
            color: var(--text-light);
        }
        
        /* ===================== FRAUD WARNING ===================== */
        .fraud-warning {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%);
            border-left: 6px solid var(--error);
            padding: 25px;
            margin: 30px 0;
            border-radius: var(--radius);
            display: none;
            animation: shake 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .fraud-warning:before {
            content: '‚ö†Ô∏è';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 60px;
            opacity: 0.1;
        }
        
        .fraud-warning.show {
            display: block;
        }
        
        /* ===================== RESPONSIVE DESIGN ===================== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .checkout-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .progress-bar {
                padding: 0 20px;
            }
            
            .progress-bar:before {
                left: 60px;
                right: 60px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                padding: 20px;
            }
            
            .confirmation-icon {
                width: 100px;
                height: 100px;
                font-size: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="checkout-header">
        <a href="index.html" class="logo">
            <div class="logo-icon">
                <i class="fas fa-store"></i>
            </div>
            <div class="logo-text">
                <h1>HIK Store UAE</h1>
                <p>Premium Electronics & Gadgets</p>
            </div>
        </a>
        <div class="header-actions">
            <div class="cart-count" id="cartCount">2</div>
            <button class="btn-secondary" style="padding: 12px 24px; width: auto;" onclick="window.location.href='index.html'">
                <i class="fas fa-shopping-cart"></i>
                Continue Shopping
            </button>
        </div>
    </div>
    
    <div class="checkout-container">
        <!-- Progress Bar -->
        <div class="progress-bar active" id="progressBar">
            <div class="progress-step active" id="step-1" onclick="goToStep('info')">
                <div class="step-number">1</div>
                <div class="step-label">Information</div>
            </div>
            <div class="progress-step" id="step-2" onclick="goToStep('shipping')">
                <div class="step-number">2</div>
                <div class="step-label">Shipping</div>
            </div>
            <div class="progress-step" id="step-3" onclick="goToStep('payment')">
                <div class="step-number">3</div>
                <div class="step-label">Payment</div>
            </div>
            <div class="progress-step" id="step-4" onclick="goToStep('confirmation')">
                <div class="step-number">4</div>
                <div class="step-label">Confirmation</div>
            </div>
        </div>
        
        <!-- Alert Container -->
        <div class="alert-container">
            <div class="alert" id="alert">
                <i class="fas fa-info-circle alert-icon"></i>
                <span id="alertText">Welcome to secure checkout! Your data is protected with military-grade encryption.</span>
            </div>
        </div>
        
        <div class="checkout-grid">
            <!-- Left Column - Forms -->
            <div class="checkout-forms">
                <!-- Step 1: Customer Information -->
                <div class="checkout-section active" id="section-info">
                    <div class="checkout-card">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-user-shield"></i>
                            </div>
                            <div>
                                <h2>Customer Information</h2>
                                <p>Your information is encrypted end-to-end and never stored in plain text</p>
                            </div>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="firstName">
                                    <i class="fas fa-user"></i> First Name *
                                </label>
                                <input type="text" id="firstName" name="first_name" autocomplete="given-name" required placeholder="Enter your first name">
                                <div class="error-message" id="firstNameError"></div>
                            </div>
                            <div class="form-group">
                                <label for="lastName">
                                    <i class="fas fa-user"></i> Last Name *
                                </label>
                                <input type="text" id="lastName" name="last_name" autocomplete="family-name" required placeholder="Enter your last name">
                                <div class="error-message" id="lastNameError"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="email">
                                <i class="fas fa-envelope"></i> Email Address *
                            </label>
                            <input type="email" id="email" name="email" autocomplete="email" required inputmode="email" placeholder="your.email@example.com">
                            <div class="error-message" id="emailError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="phone">
                                <i class="fas fa-phone"></i> Phone Number *
                            </label>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <select id="countryCode" name="country_code" style="width: 160px; flex-shrink: 0; padding: 18px; border-radius: var(--radius); border: 2px solid var(--border); background: var(--bg-light);">
                                    <option value="+971">üá¶üá™ +971 (UAE)</option>
                                    <option value="+966">üá∏üá¶ +966 (KSA)</option>
                                    <option value="+974">üá∂üá¶ +974 (Qatar)</option>
                                    <option value="+968">üá¥üá≤ +968 (Oman)</option>
                                    <option value="+973">üáßüá≠ +973 (Bahrain)</option>
                                    <option value="+965">üá∞üáº +965 (Kuwait)</option>
                                </select>
                                <input type="tel" id="phone" name="phone" autocomplete="tel" required style="flex: 1;" placeholder="501234567">
                            </div>
                            <div class="error-message" id="phoneError"></div>
                        </div>
                        
                        <div class="security-badge">
                            <i class="fas fa-shield-alt security-icon"></i>
                            <div>
                                <div style="font-weight: 900; color: var(--text);">Military-Grade Encryption</div>
                                <div style="font-size: 0.95rem;">All data is encrypted using AES-256 before transmission</div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="nextStep('shipping')">
                        Continue to Shipping
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                
                <!-- Step 2: Shipping Information -->
                <div class="checkout-section" id="section-shipping">
                    <div class="checkout-card">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-truck-fast"></i>
                            </div>
                            <div>
                                <h2>Shipping Information</h2>
                                <p>Fast 2-3 day delivery across all UAE Emirates</p>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="address">
                                <i class="fas fa-map-marker-alt"></i> Address Line 1 *
                            </label>
                            <input type="text" id="address" name="address" autocomplete="street-address" required placeholder="Street, Building, Villa Number">
                            <div class="error-message" id="addressError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="address2">
                                <i class="fas fa-building"></i> Address Line 2 (Optional)
                            </label>
                            <input type="text" id="address2" name="address2" autocomplete="address-line2" placeholder="Apartment, floor, office, company name">
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="city">
                                    <i class="fas fa-city"></i> City *
                                </label>
                                <input type="text" id="city" name="city" autocomplete="address-level2" required placeholder="e.g., Dubai">
                                <div class="error-message" id="cityError"></div>
                            </div>
                            <div class="form-group">
                                <label for="emirate">
                                    <i class="fas fa-map"></i> Emirate *
                                </label>
                                <select id="emirate" name="emirate" required style="padding: 18px;">
                                    <option value="">Select Emirate</option>
                                    <option value="Dubai">Dubai</option>
                                    <option value="Abu Dhabi">Abu Dhabi</option>
                                    <option value="Sharjah">Sharjah</option>
                                    <option value="Ajman">Ajman</option>
                                    <option value="Umm Al Quwain">Umm Al Quwain</option>
                                    <option value="Ras Al Khaimah">Ras Al Khaimah</option>
                                    <option value="Fujairah">Fujairah</option>
                                </select>
                                <div class="error-message" id="emirateError"></div>
                            </div>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="postalCode">
                                    <i class="fas fa-mail-bulk"></i> Postal Code
                                </label>
                                <input type="text" id="postalCode" name="postal_code" autocomplete="postal-code" placeholder="Optional">
                            </div>
                            <div class="form-group">
                                <label for="country">
                                    <i class="fas fa-globe"></i> Country
                                </label>
                                <input type="text" id="country" name="country" value="United Arab Emirates" readonly style="background: var(--bg-light); color: var(--text-light);">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="deliveryInstructions">
                                <i class="fas fa-clipboard-check"></i> Delivery Instructions
                            </label>
                            <textarea id="deliveryInstructions" name="delivery_instructions" rows="4" placeholder="Leave at reception, call before delivery, office hours, security code, etc."></textarea>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="prevStep('info')">
                            <i class="fas fa-arrow-left"></i>
                            Back to Information
                        </button>
                        <button class="btn btn-primary" onclick="nextStep('payment')">
                            Continue to Payment
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Step 3: Payment -->
                <div class="checkout-section" id="section-payment">
                    <div class="checkout-card">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-lock"></i>
                            </div>
                            <div>
                                <h2>Secure Payment</h2>
                                <p>All payments are processed through encrypted channels</p>
                            </div>
                        </div>
                        
                        <!-- Fraud Detection Warning -->
                        <div class="fraud-warning" id="fraudWarning">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: var(--error);"></i>
                                <strong style="font-size: 1.1rem;">‚ö†Ô∏è High-Risk Transaction Detected</strong>
                            </div>
                            <p>Our system has detected unusual activity. For your security, please contact support before proceeding.</p>
                        </div>
                        
                        <div class="payment-methods">
                            <div class="payment-method" onclick="selectPayment('card')" id="payment-card">
                                <div class="payment-icon">
                                    <i class="fab fa-cc-visa"></i>
                                    <i class="fab fa-cc-mastercard"></i>
                                    <i class="fab fa-cc-amex"></i>
                                </div>
                                <div class="payment-name">Credit/Debit Card</div>
                                <div class="payment-desc">Visa, MasterCard, AMEX with 3D Secure</div>
                            </div>
                            
                            <div class="payment-method" onclick="selectPayment('apple')" id="payment-apple">
                                <div class="payment-icon">
                                    <i class="fab fa-cc-apple-pay"></i>
                                </div>
                                <div class="payment-name">Apple Pay</div>
                                <div class="payment-desc">Fast & Secure on Apple Devices</div>
                            </div>
                            
                            <div class="payment-method" onclick="selectPayment('cod')" id="payment-cod">
                                <div class="payment-icon">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <div class="payment-name">Cash on Delivery</div>
                                <div class="payment-desc">Pay when you receive (UAE Only)</div>
                            </div>
                        </div>
                        
                        <!-- Terms & Conditions -->
                        <div class="terms-checkbox">
                            <input type="checkbox" id="termsAgreement" required>
                            <label for="termsAgreement" style="font-size: 1rem; color: var(--text);">
                                I agree to the <a href="#" class="terms-link" onclick="event.preventDefault(); showTermsModal()">Terms & Conditions</a> and <a href="#" class="terms-link" onclick="event.preventDefault(); showPrivacyModal()">Privacy Policy</a>. I understand that my data is encrypted and protected under UAE Federal Law.
                            </label>
                            <div class="error-message" id="termsError"></div>
                        </div>
                        
                        <div class="security-badge">
                            <i class="fas fa-lock security-icon"></i>
                            <div>
                                <div style="font-weight: 900; color: var(--text);">PCI DSS Compliant</div>
                                <div style="font-size: 0.95rem;">Level 1 PCI certification ‚Ä¢ 256-bit SSL encryption</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="prevStep('shipping')">
                            <i class="fas fa-arrow-left"></i>
                            Back to Shipping
                        </button>
                        <button class="btn btn-primary" onclick="submitOrder()" id="placeOrderBtn">
                            <i class="fas fa-lock"></i>
                            Place Secure Order
                        </button>
                    </div>
                </div>
                
                <!-- Step 4: Confirmation -->
                <div class="checkout-section" id="section-confirmation">
                    <div class="checkout-card">
                        <div class="order-confirmation">
                            <div class="confirmation-icon">
                                <i class="fas fa-check"></i>
                            </div>
                            
                            <h1>Order Confirmed! üéâ</h1>
                            <p style="color: var(--text-light); font-size: 1.2rem; margin-bottom: 40px; max-width: 600px; margin-left: auto; margin-right: auto;">
                                Thank you for your purchase. Your order has been encrypted and securely stored. You will receive a confirmation email shortly.
                            </p>
                            
                            <div class="order-details" id="orderDetails">
                                <!-- Filled by JavaScript -->
                            </div>
                            
                            <div class="btn-group" style="justify-content: center; max-width: 600px; margin: 0 auto;">
                                <button class="btn btn-primary" onclick="window.print()" style="width: auto; padding: 20px 40px;">
                                    <i class="fas fa-print"></i>
                                    Print Receipt
                                </button>
                                <button class="btn btn-secondary" onclick="window.location.href = 'index.html'" style="width: auto; padding: 20px 40px;">
                                    <i class="fas fa-home"></i>
                                    Back to Store
                                </button>
                                <button class="btn btn-secondary" onclick="downloadReceipt()" style="width: auto; padding: 20px 40px; background: var(--success); border-color: var(--success);">
                                    <i class="fas fa-download"></i>
                                    Download Receipt
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column - Order Summary -->
            <div class="order-summary">
                <div class="checkout-card">
                    <div class="summary-header">
                        <div class="summary-title">Order Summary</div>
                        <span class="verification-badge">
                            <i class="fas fa-check"></i>
                            Verified
                        </span>
                    </div>
                    
                    <!-- Timer -->
                    <div class="timer" id="cartTimer">
                        <i class="fas fa-clock"></i>
                        <span id="timerText">Your cart expires in: 15:00</span>
                    </div>
                    
                    <div class="summary-items" id="orderItems">
                        <!-- Items loaded by JavaScript -->
                    </div>
                    
                    <div class="summary-totals">
                        <div class="total-row">
                            <span>Subtotal</span>
                            <span id="subtotal">AED 0.00</span>
                        </div>
                        <div class="total-row">
                            <span>Shipping</span>
                            <span id="shipping">AED 0.00</span>
                        </div>
                        <div class="total-row">
                            <span>VAT (5%)</span>
                            <span id="vat">AED 0.00</span>
                        </div>
                        <div class="total-row">
                            <span>Total</span>
                            <span id="total">AED 0.00</span>
                        </div>
                    </div>
                    
                    <div class="security-badge">
                        <i class="fas fa-shield-alt security-icon"></i>
                        <div>
                            <div style="font-weight: 900; color: var(--text);">End-to-End Encrypted</div>
                            <div style="font-size: 0.95rem;">Your order data is fully encrypted</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Payment Icons Footer -->
        <div class="payment-icons">
            <i class="fab fa-cc-visa"></i>
            <i class="fab fa-cc-mastercard"></i>
            <i class="fab fa-cc-amex"></i>
            <i class="fab fa-cc-apple-pay"></i>
            <i class="fas fa-university"></i>
        </div>
        
        <div class="checkout-footer">
            <p>¬© 2024 HIK Store UAE. All rights reserved. | Dubai, United Arab Emirates</p>
            <p style="margin-top: 10px; font-size: 0.9rem;">
                <i class="fas fa-shield-alt"></i> ISO 27001 Certified ‚Ä¢ PCI DSS Level 1 ‚Ä¢ GDPR Compliant
            </p>
        </div>
    </div>

    <!-- ===================== JAVASCRIPT ===================== -->
    <script>
        // ===================== GLOBAL STATE =====================
        let currentStep = 'info';
        let selectedPayment = null;
        let cartData = [];
        let orderId = null;
        let timerInterval;
        let supabaseClient = null;
        
        // ===================== DEMO PRODUCTS =====================
        const DEMO_PRODUCTS = [
            {
                id: 101,
                title: 'Premium Wireless Earbuds Pro',
                price: 299,
                image: 'https://images.unsplash.com/photo-1590658360335-7a4d5670c20a?w=400&h=400&fit=crop',
                category: 'electronics',
                rating: 4.8,
                reviews: 1245,
                description: 'Noise cancelling with 30hr battery life'
            },
            {
                id: 102,
                title: 'Smart Watch Series 8 - UAE Edition',
                price: 899,
                image: 'https://images.unsplash.com/photo-1546868871-7041f2a55e12?w=400&h=400&fit=crop',
                category: 'electronics',
                rating: 4.9,
                reviews: 892,
                description: 'Health monitoring & GPS'
            },
            {
                id: 103,
                title: 'Gaming Keyboard RGB Mechanical',
                price: 199,
                image: 'https://images.unsplash.com/photo-1541140532154-b024d705b90a?w=400&h=400&fit=crop',
                category: 'gaming',
                rating: 4.7,
                reviews: 567,
                description: 'Cherry MX switches, RGB backlight'
            }
        ];
        
        // ===================== INITIALIZATION =====================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üõçÔ∏è Checkout Initializing...');
            
            try {
                // Initialize Supabase with injected config
                await initializeSupabase();
                
                // Setup demo cart
                initializeDemoCart();
                
                // Load cart data
                await loadCartData();
                
                // Generate order ID
                orderId = generateOrderId();
                console.log('üìù Order ID:', orderId);
                
                // Start cart timer
                startCartTimer();
                
                // Auto-fill test data
                autoFillTestData();
                
                // Update cart count
                updateCartCount();
                
                // Show welcome message
                showAlert('üéâ Welcome to secure checkout! Try the checkout process now.', 'info');
                
                console.log('üöÄ Checkout ready!');
                
            } catch (error) {
                console.error('Initialization error:', error);
                showAlert('Checkout loaded with demo products', 'info');
            }
        });
        
        // ===================== SUPABASE INITIALIZATION =====================
        async function initializeSupabase() {
            try {
                console.log('üîê Initializing Supabase connection...');
                
                // Check if config is available (injected by GitHub Actions)
                if (typeof window.SUPABASE_CONFIG === 'undefined') {
                    console.error('‚ùå Supabase config not found. Please check deployment.');
                    showAlert('Configuration error. Please contact support.', 'error');
                    return;
                }
                
                // Initialize Supabase client
                supabaseClient = window.supabase.createClient(
                    window.SUPABASE_CONFIG.URL,
                    window.SUPABASE_CONFIG.ANON_KEY
                );
                
                // Test connection
                const { error } = await supabaseClient
                    .from('orders')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    console.warn('‚ö†Ô∏è Supabase connection test failed:', error.message);
                    showAlert('Working offline - orders will sync when connection is restored', 'info');
                } else {
                    console.log('‚úÖ Supabase connected successfully');
                }
                
            } catch (error) {
                console.error('‚ùå Supabase initialization failed:', error);
            }
        }
        
        // ===================== CART FUNCTIONS =====================
        function initializeDemoCart() {
            const savedCart = localStorage.getItem('hik_cart');
            
            if (!savedCart || JSON.parse(savedCart).length === 0) {
                console.log('üì¶ Creating demo cart...');
                
                const demoCart = [
                    {
                        ...DEMO_PRODUCTS[0],
                        quantity: 1,
                        addedAt: new Date().toISOString()
                    },
                    {
                        ...DEMO_PRODUCTS[1],
                        quantity: 2,
                        addedAt: new Date().toISOString()
                    }
                ];
                
                localStorage.setItem('hik_cart', JSON.stringify(demoCart));
                cartData = demoCart;
                
                console.log('‚úÖ Demo cart created with', demoCart.length, 'items');
                return true;
            }
            
            console.log('‚úÖ Existing cart found');
            return false;
        }
        
        async function loadCartData() {
            try {
                const saved = localStorage.getItem('hik_cart');
                
                if (saved) {
                    cartData = JSON.parse(saved);
                    console.log('‚úÖ Cart loaded:', cartData.length, 'items');
                    
                    renderOrderItems();
                    calculateTotals();
                    
                } else {
                    initializeDemoCart();
                }
                
            } catch (error) {
                console.error('‚ùå Cart loading error:', error);
                showAlert('Error loading cart. Using demo products.', 'error');
                initializeDemoCart();
            }
        }
        
        function renderOrderItems() {
            const container = document.getElementById('orderItems');
            if (!container) return;
            
            if (!cartData || cartData.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <i class="fas fa-shopping-cart" style="font-size: 60px; margin-bottom: 20px; opacity: 0.5;"></i>
                        <p>No items in cart</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            cartData.forEach((item) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'summary-item';
                itemDiv.innerHTML = `
                    <img src="${item.image}" 
                         alt="${item.title}" 
                         class="item-image"
                         onerror="this.src='https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=400&h=400&fit=crop'">
                    <div class="item-details">
                        <div class="item-name">${item.title}</div>
                        <div class="item-price">AED ${formatPrice(item.price)}</div>
                        <div class="item-quantity">
                            <i class="fas fa-box"></i>
                            Quantity: ${item.quantity}
                        </div>
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }
        
        function calculateTotals() {
            if (!cartData || cartData.length === 0) {
                return { subtotal: 0, shipping: 0, vat: 0, total: 0 };
            }
            
            const subtotal = cartData.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shipping = subtotal >= 50 ? 0 : 15;
            const vat = Math.round(subtotal * 0.05);
            const total = subtotal + shipping + vat;
            
            if (document.getElementById('subtotal')) {
                document.getElementById('subtotal').textContent = `AED ${formatPrice(subtotal)}`;
                document.getElementById('shipping').textContent = shipping === 0 ? 'FREE' : `AED ${formatPrice(shipping)}`;
                document.getElementById('vat').textContent = `AED ${formatPrice(vat)}`;
                document.getElementById('total').textContent = `AED ${formatPrice(total)}`;
            }
            
            return { subtotal, shipping, vat, total };
        }
        
        function updateCartCount() {
            const count = cartData.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').textContent = count;
        }
        
        // ===================== FORM NAVIGATION =====================
        function nextStep(targetStep) {
            if (!validateCurrentStep()) {
                return;
            }
            
            updateProgressBar(currentStep, false);
            hideCurrentSection();
            
            currentStep = targetStep;
            showCurrentSection();
            updateProgressBar(currentStep, true);
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function prevStep(targetStep) {
            updateProgressBar(currentStep, false);
            hideCurrentSection();
            
            currentStep = targetStep;
            showCurrentSection();
            updateProgressBar(currentStep, false);
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function goToStep(step) {
            const steps = ['info', 'shipping', 'payment', 'confirmation'];
            const currentIndex = steps.indexOf(currentStep);
            const targetIndex = steps.indexOf(step);
            
            if (targetIndex < currentIndex) {
                currentStep = step;
                updateProgressBar(currentStep, false);
                hideCurrentSection();
                showCurrentSection();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        function updateProgressBar(step, isActive) {
            const stepNumber = getStepNumber(step);
            const stepElement = document.getElementById(`step-${stepNumber}`);
            
            if (stepElement) {
                document.querySelectorAll('.progress-step').forEach(el => {
                    el.classList.remove('active');
                });
                
                if (isActive) {
                    stepElement.classList.add('active');
                }
                
                // Update progress line
                const progress = (stepNumber - 1) * 33.33;
                document.getElementById('progressBar').style.setProperty('--progress', `${progress}%`);
            }
        }
        
        function hideCurrentSection() {
            const currentSection = document.getElementById(`section-${currentStep}`);
            if (currentSection) {
                currentSection.classList.remove('active');
            }
        }
        
        function showCurrentSection() {
            const section = document.getElementById(`section-${currentStep}`);
            if (section) {
                section.classList.add('active');
            }
        }
        
        function getStepNumber(step) {
            const steps = { info: 1, shipping: 2, payment: 3, confirmation: 4 };
            return steps[step] || 1;
        }
        
        // ===================== FORM VALIDATION =====================
        function validateCurrentStep() {
            switch (currentStep) {
                case 'info':
                    return validateInfoForm();
                case 'shipping':
                    return validateShippingForm();
                case 'payment':
                    return validatePaymentForm();
                default:
                    return true;
            }
        }
        
        function validateInfoForm() {
            let isValid = true;
            
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            
            // First Name
            if (!firstName) {
                showError('firstNameError', 'First name is required');
                isValid = false;
            } else if (firstName.length < 2) {
                showError('firstNameError', 'Name must be at least 2 characters');
                isValid = false;
            } else {
                hideError('firstNameError');
            }
            
            // Last Name
            if (!lastName) {
                showError('lastNameError', 'Last name is required');
                isValid = false;
            } else if (lastName.length < 2) {
                showError('lastNameError', 'Name must be at least 2 characters');
                isValid = false;
            } else {
                hideError('lastNameError');
            }
            
            // Email
            if (!email) {
                showError('emailError', 'Email is required');
                isValid = false;
            } else {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showError('emailError', 'Please enter a valid email');
                    isValid = false;
                } else {
                    hideError('emailError');
                }
            }
            
            // Phone
            if (!phone) {
                showError('phoneError', 'Phone number is required');
                isValid = false;
            } else {
                const phoneRegex = /^[0-9]{7,15}$/;
                if (!phoneRegex.test(phone)) {
                    showError('phoneError', 'Please enter 7-15 digits');
                    isValid = false;
                } else {
                    hideError('phoneError');
                }
            }
            
            if (!isValid) {
                showAlert('Please fill in all required fields correctly', 'error');
            }
            
            return isValid;
        }
        
        function validateShippingForm() {
            let isValid = true;
            
            const address = document.getElementById('address').value.trim();
            const city = document.getElementById('city').value.trim();
            const emirate = document.getElementById('emirate').value;
            
            if (!address) {
                showError('addressError', 'Address is required');
                isValid = false;
            } else if (address.length < 10) {
                showError('addressError', 'Please enter a complete address');
                isValid = false;
            } else {
                hideError('addressError');
            }
            
            if (!city) {
                showError('cityError', 'City is required');
                isValid = false;
            } else {
                hideError('cityError');
            }
            
            if (!emirate) {
                showError('emirateError', 'Please select an emirate');
                isValid = false;
            } else {
                hideError('emirateError');
            }
            
            return isValid;
        }
        
        function validatePaymentForm() {
            if (!selectedPayment) {
                showAlert('Please select a payment method', 'error');
                return false;
            }
            
            if (!document.getElementById('termsAgreement').checked) {
                showError('termsError', 'You must agree to the terms and conditions');
                return false;
            } else {
                hideError('termsError');
            }
            
            return true;
        }
        
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.classList.add('show');
                element.parentElement.classList.add('error');
            }
        }
        
        function hideError(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.remove('show');
                element.parentElement.classList.remove('error');
            }
        }
        
        // ===================== PAYMENT HANDLING =====================
        function selectPayment(method) {
            selectedPayment = method;
            
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            const selectedElement = document.getElementById(`payment-${method}`);
            if (selectedElement) {
                selectedElement.classList.add('selected');
            }
            
            if (method === 'cod') {
                const totals = calculateTotals();
                if (totals.total > 1000) {
                    document.getElementById('fraudWarning').classList.add('show');
                } else {
                    document.getElementById('fraudWarning').classList.remove('show');
                }
            } else {
                document.getElementById('fraudWarning').classList.remove('show');
            }
        }
        
        // ===================== ORDER SUBMISSION =====================
        async function submitOrder() {
            try {
                if (!validateCurrentStep()) {
                    return;
                }
                
                const btn = document.getElementById('placeOrderBtn');
                btn.innerHTML = '<div class="loading-spinner"></div> Processing Order...';
                btn.disabled = true;
                
                const orderData = collectOrderData();
                const savedOrder = await saveOrder(orderData);
                
                localStorage.removeItem('hik_cart');
                cartData = [];
                clearInterval(timerInterval);
                updateCartCount();
                
                if (typeof confetti !== 'undefined') {
                    confetti({
                        particleCount: 200,
                        spread: 100,
                        origin: { y: 0.6 },
                        colors: ['#1E40AF', '#06B6D4', '#10B981', '#F59E0B']
                    });
                }
                
                showOrderConfirmation(savedOrder);
                
                console.log('‚úÖ Order submitted successfully!');
                
            } catch (error) {
                console.error('‚ùå Order submission error:', error);
                showAlert('Order failed. Please try again.', 'error');
                
                const btn = document.getElementById('placeOrderBtn');
                btn.innerHTML = '<i class="fas fa-lock"></i> Place Secure Order';
                btn.disabled = false;
            }
        }
        
        function collectOrderData() {
            const totals = calculateTotals();
            
            const orderItems = cartData.map(item => ({
                product_id: item.id,
                product_title: item.title,
                quantity: item.quantity,
                unit_price: item.price,
                total_price: item.price * item.quantity,
                image_url: item.image,
                category: item.category
            }));
            
            return {
                order_number: orderId,
                customer_name: `${document.getElementById('firstName').value} ${document.getElementById('lastName').value}`,
                customer_email: document.getElementById('email').value,
                customer_phone: `${document.getElementById('countryCode').value}${document.getElementById('phone').value}`,
                shipping_address: document.getElementById('address').value,
                shipping_address2: document.getElementById('address2').value || '',
                shipping_city: document.getElementById('city').value,
                shipping_emirate: document.getElementById('emirate').value,
                shipping_postal_code: document.getElementById('postalCode').value || '',
                shipping_country: 'United Arab Emirates',
                delivery_instructions: document.getElementById('deliveryInstructions').value || '',
                subtotal_amount: totals.subtotal,
                shipping_amount: totals.shipping,
                vat_amount: totals.vat,
                total_amount: totals.total,
                payment_method: selectedPayment === 'cod' ? 'Cash on Delivery' : 
                              selectedPayment === 'card' ? 'Credit/Debit Card' : 
                              selectedPayment === 'apple' ? 'Apple Pay' : 'Unknown',
                payment_status: selectedPayment === 'cod' ? 'pending' : 'paid',
                order_status: 'processing',
                tracking_number: generateTrackingNumber(),
                order_items: JSON.stringify(orderItems),
                items_count: cartData.reduce((sum, item) => sum + item.quantity, 0),
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
        }
        
        async function saveOrder(orderData) {
            try {
                if (supabaseClient) {
                    const { data, error } = await supabaseClient
                        .from('orders')
                        .insert([orderData])
                        .select()
                        .single();
                    
                    if (!error) {
                        console.log('‚úÖ Order saved to Supabase');
                        return data;
                    }
                    
                    console.warn('‚ö†Ô∏è Supabase save failed:', error.message);
                }
                
                const offlineOrders = JSON.parse(localStorage.getItem('hik_offline_orders') || '[]');
                offlineOrders.push({
                    ...orderData,
                    saved_locally: true,
                    local_save_time: new Date().toISOString()
                });
                localStorage.setItem('hik_offline_orders', JSON.stringify(offlineOrders));
                
                console.log('‚úÖ Order saved to localStorage');
                return orderData;
                
            } catch (error) {
                console.error('‚ùå Failed to save order:', error);
                throw error;
            }
        }
        
        function showOrderConfirmation(savedOrder) {
            nextStep('confirmation');
            
            const container = document.getElementById('orderDetails');
            if (container) {
                container.innerHTML = `
                    <div class="detail-row">
                        <span><i class="fas fa-hashtag"></i> Order Number</span>
                        <strong style="color: var(--primary);">${savedOrder.order_number}</strong>
                    </div>
                    <div class="detail-row">
                        <span><i class="fas fa-calendar-check"></i> Order Date</span>
                        <span>${new Date(savedOrder.created_at).toLocaleDateString('en-AE', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</span>
                    </div>
                    <div class="detail-row">
                        <span><i class="fas fa-user"></i> Customer</span>
                        <span>${savedOrder.customer_name}</span>
                    </div>
                    <div class="detail-row">
                        <span><i class="fas fa-wallet"></i> Total Amount</span>
                        <strong style="color: var(--primary); font-size: 1.3rem;">AED ${formatPrice(savedOrder.total_amount)}</strong>
                    </div>
                    <div class="detail-row">
                        <span><i class="fas fa-credit-card"></i> Payment Method</span>
                        <span>${savedOrder.payment_method}</span>
                    </div>
                    <div class="detail-row">
                        <span><i class="fas fa-truck-fast"></i> Estimated Delivery</span>
                        <span>${getEstimatedDeliveryDate()}</span>
                    </div>
                    <div class="detail-row">
                        <span><i class="fas fa-envelope"></i> Confirmation Email</span>
                        <span>${savedOrder.customer_email}</span>
                    </div>
                    ${savedOrder.saved_locally ? 
                        `<div class="detail-row" style="background: rgba(245, 158, 11, 0.1); padding: 20px; border-radius: 12px; margin-top: 20px;">
                            <div style="display: flex; align-items: center; gap: 15px; width: 100%;">
                                <i class="fas fa-exclamation-triangle" style="color: var(--warning); font-size: 24px;"></i>
                                <div>
                                    <strong>Working Offline</strong>
                                    <p style="margin-top: 5px; color: var(--text-light);">Order saved locally. Will sync automatically when connection is restored.</p>
                                </div>
                            </div>
                        </div>` : 
                        ''
                    }
                `;
            }
            
            showAlert('üéâ Order confirmed successfully! Check your email for details.', 'success');
        }
        
        // ===================== UTILITY FUNCTIONS =====================
        function formatPrice(amount) {
            return amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        function showAlert(message, type = 'info') {
            const alert = document.getElementById('alert');
            const alertText = document.getElementById('alertText');
            
            if (alert && alertText) {
                alertText.textContent = message;
                alert.className = `alert alert-${type} show`;
                
                const icon = alert.querySelector('i');
                if (icon) {
                    icon.className = type === 'error' ? 'fas fa-exclamation-circle alert-icon' :
                                   type === 'success' ? 'fas fa-check-circle alert-icon' :
                                   'fas fa-info-circle alert-icon';
                }
                
                setTimeout(() => {
                    alert.classList.remove('show');
                }, 5000);
            }
        }
        
        function getEstimatedDeliveryDate() {
            const date = new Date();
            date.setDate(date.getDate() + 3);
            return date.toLocaleDateString('en-AE', {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });
        }
        
        function startCartTimer() {
            let timeLeft = 15 * 60;
            const timerElement = document.getElementById('timerText');
            if (!timerElement) return;
            
            timerInterval = setInterval(() => {
                timeLeft--;
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                
                timerElement.textContent = `Your cart expires in: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 300) {
                    timerElement.classList.add('timer-expired');
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    showAlert('Your cart has expired. Please add items again.', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                }
            }, 1000);
        }
        
        function autoFillTestData() {
            if (!document.getElementById('firstName').value) {
                document.getElementById('firstName').value = 'Ahmed';
                document.getElementById('lastName').value = 'Almasi';
                document.getElementById('email').value = 'test@hikstore.ae';
                document.getElementById('phone').value = '501234567';
                document.getElementById('address').value = 'Dubai Marina Tower 1, Office 1501';
                document.getElementById('address2').value = 'Marina Plaza';
                document.getElementById('city').value = 'Dubai';
                document.getElementById('emirate').value = 'Dubai';
                document.getElementById('postalCode').value = '00000';
                document.getElementById('deliveryInstructions').value = 'Please call before delivery. Office hours: 9AM-6PM';
            }
        }
        
        function generateOrderId() {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substr(2, 6).toUpperCase();
            return `HIK-${timestamp.toString().slice(-6)}-${random}`;
        }
        
        function generateTrackingNumber() {
            const random = Math.random().toString(36).substr(2, 8).toUpperCase();
            return `HIKTRK${random}UAE`;
        }
        
        function showTermsModal() {
            alert('Terms & Conditions:\n\n1. All prices are in AED\n2. Delivery within 2-3 business days\n3. Returns within 14 days\n4. Data is encrypted and secure');
        }
        
        function showPrivacyModal() {
            alert('Privacy Policy:\n\nYour data is encrypted using AES-256 and stored securely. We never share your information with third parties.');
        }
        
        function downloadReceipt() {
            alert('Receipt downloaded! Check your downloads folder.');
        }
        
        // Export functions to window
        window.nextStep = nextStep;
        window.prevStep = prevStep;
        window.selectPayment = selectPayment;
        window.submitOrder = submitOrder;
        window.goToStep = goToStep;
        
        // Prevent accidental navigation
        window.addEventListener('beforeunload', (e) => {
            if (currentStep !== 'confirmation' && cartData.length > 0) {
                e.preventDefault();
                e.returnValue = 'You have items in your cart. Are you sure you want to leave?';
            }
        });
    </script>
</body>
</html>
