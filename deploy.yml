name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: OVERWRITE config.js with Injected Secrets
        run: |
          # This completely replaces the config.js file.
          cat > config.js << 'EOF'
          // config.js - AUTO-GENERATED BY GITHUB ACTIONS
          console.log('âœ… CONFIG INJECTED BY GITHUB ACTIONS');

          window.SUPABASE_CONFIG = {
            URL: "${{ secrets.SUPABASE_URL }}",
            ANON_KEY: "${{ secrets.SUPABASE_ANON_KEY }}",
            PAYPAL_CLIENT_ID: "${{ secrets.PAYPAL_CLIENT_ID || '' }}",
            ENV: 'production',
            INJECTED_BY_WORKFLOW: true
          };

          // Immediate validation
          if (!window.SUPABASE_CONFIG.URL || !window.SUPABASE_CONFIG.ANON_KEY) {
            console.error('âŒ ERROR: Supabase secrets were NOT injected.');
            window.SUPABASE_CONFIG.FALLBACK_MODE = true;
          } else {
            console.log('ðŸ”— Supabase URL is present.');
            console.log('ðŸ”‘ Supabase Key is present.');
            window.SUPABASE_CONFIG.FALLBACK_MODE = false;
          }
          EOF

          echo "ðŸ“„ New config.js file created."
          echo "First 5 lines:"
          head -5 config.js

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
