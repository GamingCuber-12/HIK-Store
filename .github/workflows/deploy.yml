name: Ultra Secure Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Minimal permissions - security principle of least privilege
permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Ultra Security Scan
        run: |
          echo "üîí ULTRA SECURITY AUDIT"
          echo "========================"
          
          # 1. Check for ANY secrets in code
          echo "üîç Scanning for API keys, tokens, passwords..."
          
          # Common secret patterns
          SECRET_PATTERNS=(
            "eyJ[a-zA-Z0-9_-]*\.[a-zA-Z0-9_-]*\.[a-zA-Z0-9_-]*"  # JWT tokens
            "sk_[a-zA-Z0-9]{48}"  # Stripe keys
            "sk_live_[a-zA-Z0-9]{24}"  # Stripe live keys
            "AKIA[0-9A-Z]{16}"  # AWS keys
            "gh[pousr]_[A-Za-z0-9_]{36}"  # GitHub tokens
            "xox[pbar]-[0-9]{12}-[0-9]{12}-[0-9]{12}-[a-z0-9]{32}"  # Slack tokens
            "-----BEGIN PRIVATE KEY-----"  # Private keys
            "supabase\.co[/][a-zA-Z0-9]"  # Supabase URLs with paths
          )
          
          ERROR_COUNT=0
          for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -r -I "$pattern" . --include="*.js" --include="*.html" --include="*.json" --include="*.env" 2>/dev/null; then
              echo "‚ùå CRITICAL: Secret pattern '$pattern' found!"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done
          
          # 2. Check config.js doesn't have real values
          echo "üîç Checking config.js for hardcoded values..."
          if grep -q "https://.*\.supabase\.co" config.js && ! grep -q "%%ENCRYPTED_" config.js; then
            echo "‚ùå CRITICAL: Real Supabase URL in config.js!"
            ERROR_COUNT=$((ERROR_COUNT + 1))
          fi
          
          # 3. Validate placeholders exist
          echo "üîç Checking required placeholders..."
          REQUIRED_PLACEHOLDERS=(
            "%%ENCRYPTED_SUPABASE_URL%%"
            "%%ENCRYPTED_SUPABASE_KEY%%"
            "%%ENCRYPTED_PAYPAL_CLIENT_ID%%"
          )
          
          for placeholder in "${REQUIRED_PLACEHOLDERS[@]}"; do
            if ! grep -q "$placeholder" config.js; then
              echo "‚ùå MISSING: Placeholder '$placeholder' not found in config.js"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done
          
          # Final result
          if [ $ERROR_COUNT -eq 0 ]; then
            echo "‚úÖ ULTRA SECURE: No secrets found in codebase"
          else
            echo "‚ùå FAILED: $ERROR_COUNT security violations found"
            exit 1
          fi
          
      - name: Dependency Scan
        run: |
          echo "üì¶ Checking for known vulnerabilities..."
          # Check for known malicious patterns
          if grep -r "eval(" . --include="*.js" | grep -v "// SAFE:"; then
            echo "‚ùå DANGER: eval() found in code"
            exit 1
          fi
          
          if grep -r "innerHTML" . --include="*.js" | grep -v "textContent" | head -5; then
            echo "‚ö†Ô∏è WARNING: innerHTML usage detected (potential XSS)"
          fi
          
          echo "‚úÖ Code structure passed security checks"

  encrypt-secrets:
    runs-on: ubuntu-latest
    needs: security-audit
    outputs:
      supabase_url: ${{ steps.encrypt.outputs.encrypted_url }}
      supabase_key: ${{ steps.encrypt.outputs.encrypted_key }}
      paypal_id: ${{ steps.encrypt.outputs.encrypted_paypal }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Encrypt Secrets
        id: encrypt
        run: |
          # Get secrets from GitHub Secrets
          SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
          SUPABASE_KEY="${{ secrets.SUPABASE_ANON_KEY }}"
          PAYPAL_ID="${{ secrets.PAYPAL_CLIENT_ID }}"
          
          # Validate secrets exist
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_KEY" ] || [ -z "$PAYPAL_ID" ]; then
            echo "‚ùå Missing required secrets"
            exit 1
          fi
          
          # Encrypt using base64 (in production, use GPG or KMS)
          echo "üîê Encrypting secrets..."
          
          ENCRYPTED_URL=$(echo -n "$SUPABASE_URL" | base64 | tr -d '\n')
          ENCRYPTED_KEY=$(echo -n "$SUPABASE_KEY" | base64 | tr -d '\n')
          ENCRYPTED_PAYPAL=$(echo -n "$PAYPAL_ID" | base64 | tr -d '\n')
          
          # Output encrypted values
          echo "encrypted_url=$ENCRYPTED_URL" >> $GITHUB_OUTPUT
          echo "encrypted_key=$ENCRYPTED_KEY" >> $GITHUB_OUTPUT
          echo "encrypted_paypal=$ENCRYPTED_PAYPAL" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Secrets encrypted"
          echo "URL length: ${#ENCRYPTED_URL}"
          echo "Key length: ${#ENCRYPTED_KEY}"

  deploy:
    runs-on: ubuntu-latest
    needs: encrypt-secrets
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Inject Encrypted Secrets
        run: |
          echo "üîê Injecting encrypted secrets into config.js..."
          
          # Read encrypted values from previous job
          ENCRYPTED_URL="${{ needs.encrypt-secrets.outputs.supabase_url }}"
          ENCRYPTED_KEY="${{ needs.encrypt-secrets.outputs.supabase_key }}"
          ENCRYPTED_PAYPAL="${{ needs.encrypt-secrets.outputs.paypal_id }}"
          
          # Validate encrypted values
          if [ -z "$ENCRYPTED_URL" ] || [ -z "$ENCRYPTED_KEY" ]; then
            echo "‚ùå Missing encrypted values"
            exit 1
          fi
          
          # Create secure temp file
          TEMP_FILE=$(mktemp)
          
          # Replace placeholders with encrypted values
          sed \
            -e "s|%%ENCRYPTED_SUPABASE_URL%%|$ENCRYPTED_URL|g" \
            -e "s|%%ENCRYPTED_SUPABASE_KEY%%|$ENCRYPTED_KEY|g" \
            -e "s|%%ENCRYPTED_PAYPAL_CLIENT_ID%%|$ENCRYPTED_PAYPAL|g" \
            config.js > "$TEMP_FILE"
          
          # Verify replacement
          if grep -q "%%ENCRYPTED_" "$TEMP_FILE"; then
            echo "‚ùå Placeholders not fully replaced"
            exit 1
          fi
          
          # Replace original
          mv "$TEMP_FILE" config.js
          
          echo "‚úÖ Secrets injected successfully"
          echo "üìÅ Config.js size: $(wc -c < config.js) bytes"
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
