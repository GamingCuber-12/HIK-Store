name: Ultra Secure Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Debug - Show secret status
        run: |
          echo "ðŸ” Checking secrets..."
          echo "SUPABASE_URL exists: ${{ secrets.SUPABASE_URL != '' }}"
          echo "SUPABASE_ANON_KEY exists: ${{ secrets.SUPABASE_ANON_KEY != '' }}"
          echo "SUPABASE_URL starts with: ${{ secrets.SUPABASE_URL != '' && secrets.SUPABASE_URL[:20] }}..."
          echo "SUPABASE_ANON_KEY starts with: ${{ secrets.SUPABASE_ANON_KEY != '' && secrets.SUPABASE_ANON_KEY[:10] }}..."
      
      - name: Create Python script for safe replacement
        run: |
          cat > replace_secrets.py << 'EOF'
          import base64
          import os
          import sys
          
          # Read secrets from environment
          supabase_url = os.environ.get('SUPABASE_URL', '')
          supabase_key = os.environ.get('SUPABASE_KEY', '')
          paypal_id = os.environ.get('PAYPAL_ID', 'NOT_SET')
          
          print(f"ðŸ” Secrets received:")
          print(f"URL length: {len(supabase_url)}")
          print(f"Key length: {len(supabase_key)}")
          print(f"URL starts with: {supabase_url[:30]}...")
          print(f"Key starts with: {supabase_key[:20]}...")
          
          # Encode to base64
          encoded_url = base64.b64encode(supabase_url.encode()).decode()
          encoded_key = base64.b64encode(supabase_key.encode()).decode()
          encoded_paypal = base64.b64encode(paypal_id.encode()).decode() if paypal_id != 'NOT_SET' else 'NOT_SET'
          
          print(f"ðŸ“Š Encoded sizes:")
          print(f"URL: {len(encoded_url)} chars")
          print(f"Key: {len(encoded_key)} chars")
          
          # Read config.js
          with open('config.js', 'r') as f:
              content = f.read()
          
          # Replace placeholders
          new_content = content.replace('%%ENCRYPTED_SUPABASE_URL%%', encoded_url)
          new_content = new_content.replace('%%ENCRYPTED_SUPABASE_KEY%%', encoded_key)
          new_content = new_content.replace('%%ENCRYPTED_PAYPAL_CLIENT_ID%%', encoded_paypal)
          
          # Check if replacement worked
          if '%%ENCRYPTED_' in new_content:
              print("âŒ ERROR: Some placeholders not replaced!")
              for line in new_content.split('\n'):
                  if '%%ENCRYPTED_' in line:
                      print(f"Line: {line.strip()}")
              sys.exit(1)
          
          # Write back
          with open('config.js', 'w') as f:
              f.write(new_content)
          
          print("âœ… Secrets injected successfully!")
          print("ðŸ“„ First 3 lines of updated config.js:")
          print(new_content.split('\n')[0:3])
          EOF
      
      - name: Run Python replacement script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          PAYPAL_ID: ${{ secrets.PAYPAL_CLIENT_ID || 'NOT_SET' }}
        run: |
          python3 replace_secrets.py
      
      - name: Verify config.js
        run: |
          echo "ðŸ” Verifying config.js..."
          echo "File size: $(wc -l < config.js) lines"
          echo "Checking for placeholders..."
          
          if grep -q "%%ENCRYPTED_" config.js; then
            echo "âŒ ERROR: Placeholders found in config.js!"
            echo "Lines with placeholders:"
            grep -n "%%ENCRYPTED_" config.js
            exit 1
          fi
          
          echo "âœ… config.js is clean (no placeholders)"
          echo "ðŸ“„ Sample of config.js (first 5 lines, secrets hidden):"
          head -5 config.js | sed 's/"[^"]*"/"[SECRET_HIDDEN]"/g'
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
