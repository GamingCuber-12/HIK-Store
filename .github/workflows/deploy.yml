name: Ultra Secure Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  security-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify config has placeholders
        run: |
          echo "üîç Checking config.js..."
          if ! grep -q "%%ENCRYPTED_" config.js; then
            echo "‚ùå ERROR: config.js missing placeholders!"
            echo "Your config.js should contain %%ENCRYPTED_SUPABASE_URL%% and %%ENCRYPTED_SUPABASE_KEY%%"
            echo "Found in config.js:"
            grep -n "%%" config.js || echo "No placeholders found"
            exit 1
          fi
          echo "‚úÖ config.js has correct placeholders"

  deploy:
    runs-on: ubuntu-latest
    needs: security-check
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Debug - Check secrets exist
        run: |
          echo "üîê Checking if secrets are set..."
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "‚ùå SUPABASE_URL secret is empty!"
          else
            echo "‚úÖ SUPABASE_URL: Set (first 20 chars: ${SUPABASE_URL:0:20}...)"
          fi
          
          if [ -z "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "‚ùå SUPABASE_ANON_KEY secret is empty!"
          else
            echo "‚úÖ SUPABASE_ANON_KEY: Set (starts with: ${SUPABASE_ANON_KEY:0:10}...)"
          fi
          
          # Create temporary variables for debugging
          echo "SUPABASE_URL_EXISTS=$([ -n "${{ secrets.SUPABASE_URL }}" ] && echo "true" || echo "false")" >> $GITHUB_ENV
          echo "SUPABASE_KEY_EXISTS=$([ -n "${{ secrets.SUPABASE_ANON_KEY }}" ] && echo "true" || echo "false")" >> $GITHUB_ENV
      
      - name: Inject encrypted secrets
        if: env.SUPABASE_URL_EXISTS == 'true' && env.SUPABASE_KEY_EXISTS == 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          PAYPAL_ID: ${{ secrets.PAYPAL_CLIENT_ID || 'NOT_SET' }}
        run: |
          echo "üîê Injecting encrypted secrets into config.js..."
          
          # Base64 encode the secrets
          ENCODED_URL=$(echo -n "$SUPABASE_URL" | base64 -w 0)
          ENCODED_KEY=$(echo -n "$SUPABASE_KEY" | base64 -w 0)
          
          echo "üìä Encoding complete:"
          echo "URL encoded length: ${#ENCODED_URL} chars"
          echo "Key encoded length: ${#ENCODED_KEY} chars"
          
          # Create a backup of original config
          cp config.js config.js.backup
          
          # Use awk for reliable replacement (handles special characters)
          awk -v url="$ENCODED_URL" -v key="$ENCODED_KEY" -v paypal="$PAYPAL_ID" '
            /%%ENCRYPTED_SUPABASE_URL%%/ { gsub("%%ENCRYPTED_SUPABASE_URL%%", url) }
            /%%ENCRYPTED_SUPABASE_KEY%%/ { gsub("%%ENCRYPTED_SUPABASE_KEY%%", key) }
            /%%ENCRYPTED_PAYPAL_CLIENT_ID%%/ { gsub("%%ENCRYPTED_PAYPAL_CLIENT_ID%%", paypal) }
            { print }
          ' config.js.backup > config.js
          
          # Verify replacement
          echo "üîç Verifying replacements..."
          if grep -q "%%ENCRYPTED_" config.js; then
            echo "‚ùå ERROR: Placeholders still found!"
            grep -n "%%ENCRYPTED_" config.js
            echo "Restoring backup..."
            mv config.js.backup config.js
            exit 1
          fi
          
          rm config.js.backup
          echo "‚úÖ Secrets injected successfully!"
          
          # Show first few lines (without revealing full secrets)
          echo "üìÑ Updated config.js preview:"
          head -5 config.js | sed 's/".*"/"[REDACTED]"/g'
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
